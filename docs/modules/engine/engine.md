---
title: 'Render Engine'
summary: 'Wrapper around THREE.WebGLRenderer providing resize-safe initialization, per-frame callback hooks, and clock utilities for the RAF loop.'
source_paths:
  - 'src/engine/engine.ts'
last_updated: '2025-11-09'
owner: 'Mateusz NÄ™dzi'
tags: ['module', 'engine', 'rendering']
links:
  parent: '../index.md'
  siblings:
    - 'scene-manager.md'
    - 'camera-rig.md'
    - 'controls/orbit-move-controls.md'
    - 'objects/ground.md'
    - 'objects/node.md'
    - 'objects/road.md'
---

# Render Engine

> Purpose: Encapsulate three.js renderer creation and provide a deterministic RAF loop that other subsystems can subscribe to. Keeps renderer configuration isolated from application logic in `main`.

## Context & Motivation

- Problem solved: standardizes renderer setup (pixel ratio, resize handling) and surfaces timing data for animations/interpolation.
- Requirements and constraints:
  - Allow multiple subscribers via `onUpdate` without exposing raw RAF.
  - Maintain monotonic `EngineTime` including elapsed/delta/render timestamps.
  - Handle window resizes gracefully.
- Dependencies and assumptions:
  - Expects an existing `<canvas>` element generated by the app shell.

## Responsibilities & Boundaries

- In-scope:
  - Configure `THREE.WebGLRenderer` (antialias, pixel ratio, size).
  - Manage RAF lifecycle (start/stop) and broadcast timing.
- Out-of-scope:
  - Scene graph mutation (delegated to view subsystems).
  - Camera or control setup.

## Architecture & Design

- Stores renderer instance privately; exposes via `gl` getter for consumers needing low-level access.
- Maintains `started` flag and `lastMs` to compute deltas reliably.
- Uses `THREE.Clock` to derive elapsed time in milliseconds for compatibility with simulation interpolation.

## Algorithms & Complexity

- RAF loop iterates over registered callbacks: O(n) where n is number of listeners.

## Public API / Usage

```start:Engine:src/engine/engine.ts
const engine = new Engine(canvas);
engine.onUpdate((time) => {
  // e.g., controls.update(time.deltaTimeMs / 1000);
});
engine.start();
```

- `stop()` halts RAF; intended for teardown or pausing.

## Implementation Notes

- Pixel ratio clamped to 2 to balance quality and performance on high-DPI screens.
- Resize listener reuses logic for initial setup to avoid code duplication.
- Callbacks should avoid heavy allocations to keep frame time stable.

## References

- `src/main.ts`
- `docs/modules/view/index.md`
